# Contracts API Stubs

This folder contains a `mypy` compliant stub-only package that allows `mypy` to verify type hints that use `contracts_api` types. We expect it to become part of the `contracts_api` wheel itself shortly.

## How to use

The package can be generated by navigating to the folder and then running `python3.10 setup.py bdist_wheel`
The resulting wheel can then be installed via pip as usual (e.g. `pip install dist/contracts_api_stubs-0.453.1-py3-none-any.whl`)

## Notes

There is no `plz` support for this wheel as `plz` is aware of `contracts_api` package and does not need additional typing information, unlike `mypy`.

The package is versioned as `0.<vault-version-as-an-integer>.<internal-patch-version>`. For example `0.453.1` is our first patch for the stubs that work alongside Vault 4.5.3's `contracts_api`, the version should be defined in `inception_sdk/vault/contracts/stubs/setup.py`. Patches shouldn't result in any type changes, so `0.453.0` and `0.454.0` should be identical.

## Updating Stubs

This section can be ignored if you are simply looking to consume the stubs. In order to generate the stubs from a new `contracts_api` version we first use `stubgen`, which is part of `mypy`, and then apply some simple changes.

### Running Stubgen

Assuming you have `mypy`/`stubgen` and the relevant version of contracts_api (via pip or plz), you simply need to run `stubgen <path to contracts_api_folder> -o <desired output directory>`.

If using plz, `plz build //third_party/python3:contracts_api` will create the folder `plz-out/gen/third_party/python3/contracts_api/` in the relevant directory.
If using pip, `pip show contracts-api` will reveal the location

### Improving Stub Quality

The default generated stubs are very useful, but a huge amount of types are still `Any`. Most notably, the class attributes do not get typed accurately, even if the corresponding `__init__` arguments are. The `type_hint_improver.py` tool handles this for us, so run it against the output directory of the `stubgen command` as
`python3.10 -m type_hint_improver.py <stubgen output directory>`

### Restructuring Stubgen Output

The stubgen output structure doesn't match the `contracts_api` structure, so we need to restore this. As of `4.6.x` the original package structure is

```plaintext
|__ utils
|__ versions
    |__ version_400
        |__ common
            |__ types
        |__ smart_contracts
        |__ supervisor_contracts
```

whereas the stub gen output is

```plaintext
|__ common
    |__ types
|__ python3
    |__ contracts_api
        |__ utils
|__ smart_contracts
|__ supervisor_contracts
```

The next step is therefore to re-arrange the latter into the structure of the former. This process is currently a straightforward one-to-one move/copy but be wary that this may change in the future.
Double check the diff caused by this move/copy as there may be manual tweaks in the current files. These are flagged and justified by comments starting with 'MANUAL FIX`
